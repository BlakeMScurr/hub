tenets:
  - bots:
      codelingo/review:
        comments: Please use `=== null` rather than `is_null`
    name: null-check
    doc: Finds all calls to null-check
    query: |
      import codelingo/ast/php
  
      # Verify that values come directly from a request and are passed into
      # the model's method
      # TODO: verify that this handles a route - route comment has no syntactic element
      php.element({depth: any}):
        php.expr_assign:
          php.expr_variable:
            name: $httpVariable
          php.expr_methodcall({depth: any}): # PHP surprisingly appears to have objects hanging off method calls
            name: "get"
            php.expr_propertyfetch:
              name: "request"
        php.expr_staticcall:
          php.arg:
            php.expr_variable: 
              name: $httpVariable
          name: $modelMethodName

      # Collect argument name
      php.stmt_classmethod({depth: any}):
        name: $modelMethodName
        php.param:
          name: $argument

        # Trace value of argument through assignment statements
        php.expr_assign:
          php.expr_variable:
            name: $intermediaryVar
          php.expr_variable({depth: any}):
            name: $argument

        php.expr_assign:
          php.expr_variable:
            name: $concattedVar
          php.expr_variable({depth: any}):
            name: $intermediaryVar

        # Find concatenation into final variable
        php.expr_assignop_concat:
          php.expr_variable:
            name: $sqlStatement
            # the request variable may be nested inside further concatenations
            php.expr_variable({depth: any}):
              name: $concattedVar

          # Names of the methods on the database class
          # Possible improvements:
          # - syntactic sugar on repeated patterns
          # - querying for methods that call the database more explicitly
          any_of:
            @ review.comment
            php.expr_staticcall:
              php.arg:
                php.expr_variable:
                  name: $sqlStatement
              name: "getDbConnection"
            @ review.comment
            php.expr_staticcall:
              php.arg:
                php.expr_variable:
                  name: $sqlStatement
              name: "executeSql"
            @ review.comment
            php.expr_staticcall:
              php.arg:
                php.expr_variable:
                  name: $sqlStatement
              name: "getRawConnection"
            @ review.comment
            php.expr_staticcall:
              php.arg:
                php.expr_variable:
                  name: $sqlStatement
              name: "is"
            @ review.comment
            php.expr_staticcall:
              php.arg:
                php.expr_variable:
                  name: $sqlStatement
              name: "getAsArray"
            @ review.comment
            php.expr_staticcall:
              php.arg:
                php.expr_variable:
                  name: $sqlStatement
              name: "getRowAsArray"
            @ review.comment
            php.expr_staticcall:
              php.arg:
                php.expr_variable:
                  name: $sqlStatement
              name: "getColumn"
            @ review.comment
            php.expr_staticcall:
              php.arg:
                php.expr_variable:
                  name: $sqlStatement
              name: "getSingleValue"
            @ review.comment
            php.expr_staticcall:
              php.arg:
                php.expr_variable:
                  name: $sqlStatement
              name: "getCursor"
            @ review.comment
            php.expr_staticcall:
              php.arg:
                php.expr_variable:
                  name: $sqlStatement
              name: "beginTransaction"
            @ review.comment
            php.expr_staticcall:
              php.arg:
                php.expr_variable:
                  name: $sqlStatement
              name: "commitTransaction"
            @ review.comment
            php.expr_staticcall:
              php.arg:
                php.expr_variable:
                  name: $sqlStatement
              name: "rollbackTransaction"
            @ review.comment
            php.expr_staticcall:
              php.arg:
                php.expr_variable:
                  name: $sqlStatement
              name: "create"
            @ review.comment
            php.expr_staticcall:
              php.arg:
                php.expr_variable:
                  name: $sqlStatement
              name: "update"
            @ review.comment
            php.expr_staticcall:
              php.arg:
                php.expr_variable:
                  name: $sqlStatement
              name: "getParams"
            @ review.comment
            php.expr_staticcall:
              php.arg:
                php.expr_variable:
                  name: $sqlStatement
              name: "convertField"